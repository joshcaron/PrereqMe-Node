<!DOCTYPE html>
<meta charset="utf-8">
<style>

rect {
  stroke: #fff;
}

.label{
    font-family: sans-serif;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.js"></script>
<script>

var width = 1300,
    height = 650;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([0, height]);

var colors = [["#3182bd", "#6baed6", "#9ecae1", "#c6dbef"], ["#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2"], ["#31a354", "#74c476", "#a1d99b", "#c7e9c0"], ["#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb"], ["#636363", "#969696", "#bdbdbd", "#d9d9d9"]]
var root_color = "#8c6d31";
var failsafe_color = "#bdbdbd";

d3.scale.category20c().range();

function id (course){ return course.dept + course.num; }
var courses = d3.map();

var partition = d3.layout.partition()
    .children(function(d) {
        return d.prereqs.length == 0 ? null : [].concat.apply([], d.prereqs.map(
            function(or_clause_ids){
                var or_clause = or_clause_ids.map(function(or_id){
                    return courses.get(or_id);
                });
                return or_clause;
            }))
       })
    .value(function(d) { return 1 });

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var rects, labels;

d3.json("dummy_api_response.json", function(error, json) {
    json.root.color = [root_color];
    courses.set(id(json.root), json.root);
    json.coreqs .forEach(function(d){ courses.set(id(d), d); });
    json.prereqs.forEach(function(d){ courses.set(id(d), d); });

    var sel = svg.selectAll("rect")
        .data(partition(json.root))
        .enter();

    function assign_color(d){
        if (d.children){
            if(d.prereqs.length == 1){ //reuse parent hue
                var clr = d.color.slice();
                    clr.shift();
                d.children.map(function(c){
                    c.color = clr;
                    assign_color(c);
                })
            }else{ //pick new hues
                d.children.map(function(c){
                    c.color = colors[0];
                    colors.shift();
                    assign_color(c);
                })
            }
        }
    }
    assign_color(json.root);

    rects = sel.append("rect")
      .attr("x", function(d) { return x(d.x); })
      .attr("y", function(d) { return y(d.y); })
      .attr("width", function(d) { return x(d.dx); })
      .attr("height", function(d) { return y(d.dy); })
      .attr("fill", function(d) { console.log(d); return (d.color || [failsafe_color])[0]; })
      .on("click", clicked);

    labels = sel.append("text")
      .attr("transform", function(d){return "translate("+x(d.x+d.dx/2)+","+y(d.y+d.dy/2)+")"})
      .attr("class", "label")
      .attr("text-anchor", "middle")
      .text(function(d){return d.name});

});

function clicked(d) {
  x.domain([d.x, d.x + d.dx]);
  y.domain([d.y, 1]).range([d.y ? 20 : 0, height]);

  rects.transition()
      .duration(750)
      .attr("x", function(d) { return x(d.x); })
      .attr("y", function(d) { return y(d.y); })
      .attr("width", function(d) { return x(d.x + d.dx) - x(d.x); })
      .attr("height", function(d) { return y(d.y + d.dy) - y(d.y); });

  labels.transition()
      .duration(750)
      .attr("transform", function(d){return "translate("+x(d.x+d.dx/2)+","+y(d.y+d.dy/2)+")"})
}

</script>
